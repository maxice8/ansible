---
# Playbook for the server shu
- name: Setup VPS
  hosts: all

  tasks:
    - name: Merge group and host specific services
      ansible.builtin.set_fact:
        services: "{{ group_services + host_services }}"

    - name: Get DEB architecture
      ansible.builtin.command: dpkg --print-architecture
      register: deb_architecture
      check_mode: false
      changed_when: false

    - name: Load vars/settings.local.yaml
      delegate_to: localhost
      ansible.builtin.include_vars:
        file: vars/settings.local.yaml
      when: "'vars/settings.local.yaml' is file"

    - name: Setup User, SSH, and UFW
      ansible.builtin.import_role:
        name: common

    # We have to setup docker for everyone first
    - name: Setup docker
      ansible.builtin.include_role:
        name: docker
      vars:
        docker_username: "{{ username }}"

    - name: Setup services
      ansible.builtin.include_role:
        name: "{{ service }}"
      loop_control:
        loop_var: service
      loop: "{{ services }}"
      vars:
        syncthing_username: "{{ username }}"
