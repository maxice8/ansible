services:
  ts-forgejo-runner:
    image: tailscale/tailscale:stable
    # UNIQUE HOSTNAME: Prevents collision if multiple runners join the same Tailnet
    hostname: "forgejo-runner-{{ inventory_hostname }}"
    container_name: ts-forgejo-runner
    environment:
      - TS_AUTHKEY={{ container_tsclient_key }}
      # Explicitly enable DNS so we can reach git.{{ tailnet_name }}.ts.net
      # for the runner
      - TS_ACCEPT_DNS=true
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - ts-data:/var/lib/tailscale
    devices:
      - /dev/net/tun
    cap_add:
      - net_admin
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "tailscale status"]
      interval: 1s
      timeout: 5s
      retries: 60

  docker-in-docker:
    image: docker:dind
    container_name: docker_dind
    privileged: true
    command: ["dockerd", "-H", "tcp://0.0.0.0:2375", "--tls=false"]
    restart: unless-stopped
    network_mode: service:ts-forgejo-runner
    depends_on:
      ts-forgejo-runner:
        condition: service_healthy

  runner:
    image: code.forgejo.org/forgejo/runner:11
    container_name: forgejo-runner
    depends_on:
      docker-in-docker:
        condition: service_started
      ts-forgejo-runner:
        condition: service_healthy
    environment:
      # Connect to the dind container on localhost (shared network stack)
      DOCKER_HOST: tcp://localhost:2375
      
      # Registration Details
      FORGEJO_INSTANCE_URL: "https://git.{{ tailnet_name }}.ts.net"
      # Token is shared; Name must be unique
      FORGEJO_RUNNER_TOKEN: "{{ forgejo_runner_token | default('') }}"
      
    volumes:
      # Mount the data directory which contains config.yml and entrypoint.sh
      - ./data:/data
    user: 1000:1000
    restart: always
    network_mode: service:ts-forgejo-runner
    
    # Execute our custom entrypoint script
    command: ["/bin/sh", "/data/entrypoint.sh"]

volumes:
  ts-data:
