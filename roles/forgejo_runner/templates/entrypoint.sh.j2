#!/bin/sh
set -e

# Navigate to the data directory
cd /data

# Check if the runner is already registered
if [ ! -f .runner ]; then
  echo "Runner credentials not found. Attempting registration for {{ inventory_hostname }}..."

  if [ -z "$FORGEJO_RUNNER_TOKEN" ]; then
    echo "Error: FORGEJO_RUNNER_TOKEN is not set. Cannot register."
    # Sleep loop to prevent crash loop, allowing you to debug
    while : ; do sleep 3600 ; done
  fi

  # Register the runner
  # --no-interactive: prevents prompts
  forgejo-runner register --no-interactive \
    --instance "$FORGEJO_INSTANCE_URL" \
    --token "$FORGEJO_RUNNER_TOKEN"
    
  echo "Registration successful."
else
  echo "Runner credentials found. Skipping registration."
fi

echo "Starting Forgejo Runner daemon..."
# Short sleep to ensure sidecars (dind) are ready
sleep 5

# Start the daemon
exec forgejo-runner daemon --config config.yml
