---
- name: Add syncthing repository and key
  block:
    - name: Add key
      ansible.builtin.get_url:
        url: https://syncthing.net/release-key.gpg
        dest: /etc/apt/keyrings/syncthing-archive-keyring.gpg
        owner: root
        mode: '0644'

    - name: Add repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable"
        state: present

- name: Install syncthing
  ansible.builtin.apt:
    name: syncthing
    state: present
    update_cache: true

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Create user for syncthing
  ansible.builtin.user:
    user: "{{ syncthing_username }}"

- name: Enable syncthing systemd service for max
  ansible.builtin.systemd_service:
    name: syncthing@{{ syncthing_username }}
    state: started
    enabled: true
