---
- name: Install dependencies for keep-vm-alive
  ansible.builtin.apt:
    name:
      - stress-ng # Required for multi-core load generation
      - curl # Required for heartbeat
    state: present

- name: Install keep-vm-alive script
  notify: Restart keep-vm-alive
  ansible.builtin.copy:
    owner: root
    group: root
    mode: "0755"
    dest: /usr/local/bin/keep-vm-alive
    content: |
      #!/usr/bin/env bash

      # Ansible Injected Variable via host_vars
      HEARTBEAT_URL="{{ heartbeat_keep_vm_alive | default('') }}"

      # CONFIGURATION
      # ----------------------------------------------------------------
      # Target Load: 25% (Must be > 20% to satisfy Oracle)
      # Duty Cycle: 20% (Active 2m / Total 10m)
      # This guarantees the 95th percentile metric captures the usage.
      # ----------------------------------------------------------------
      CPU_LOAD=25
      RUN_TIME=120  # 2 Minutes
      SLEEP_TIME=480 # 8 Minutes

      send_heartbeat() {
          if [ -n "$HEARTBEAT_URL" ]; then
              echo "Sending heartbeat..."
              curl -fsS -m 5 --retry 3 "$HEARTBEAT_URL" > /dev/null 2>&1
          fi
      }

      echo "Initializing keep-vm-alive..."
      echo "Method: stress-ng (All Cores)"
      echo "Configuration: $CPU_LOAD% Load | Active: ${RUN_TIME}s | Sleep: ${SLEEP_TIME}s"

      while true; do
          echo "Starting stress cycle..."

          # --cpu 0       : Spawns a worker for EVERY online CPU core (fixes single-core bug)
          # --cpu-load N  : Tries to maintain N% load on the cores
          # --timeout N   : Stops automatically after N seconds
          stress-ng --cpu 0 --cpu-load $CPU_LOAD --timeout $RUN_TIME --metrics-brief

          send_heartbeat
          echo "Cycle finished. sleeping..."

          sleep $SLEEP_TIME
      done

- name: Create keep-vm-alive systemd service
  ansible.builtin.copy:
    owner: root
    group: root
    mode: "0644"
    dest: /etc/systemd/system/keep-vm-alive.service
    content: |
      [Unit]
      Description=Oracle Cloud Reclamation Prevention (stress-ng)
      After=network.target

      [Service]
      ExecStart=/usr/local/bin/keep-vm-alive
      Type=simple
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable keep-vm-alive service
  ansible.builtin.service:
    service: keep-vm-alive
    state: started
    enabled: true
