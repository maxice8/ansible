---
- name: Install dependencies for keep-vm-alive
  ansible.builtin.apt:
    name:
      - stress-ng # Required for multi-core load generation
      - curl # Required for heartbeat
    state: present

- name: Install keep-vm-alive script
  notify: Restart keep-vm-alive
  ansible.builtin.copy:
    owner: root
    group: root
    mode: "0755"
    dest: /usr/local/bin/keep-vm-alive
    content: |
      #!/usr/bin/env bash

      # Ansible Injected Variable via host_vars
      HEARTBEAT_URL="{{ heartbeat_keep_vm_alive | default('') }}"

      # CONFIGURATION
      # ----------------------------------------------------------------
      # Total Cycle: 5 Minutes (Matches Pulsetic config)
      # Active: 45 Seconds
      # Sleep:  255 Seconds
      # Duty Cycle: 15% (Safe: >5% ensures 95th percentile is captured)
      # ----------------------------------------------------------------
      CPU_LOAD=25    # Target CPU load %
      RUN_TIME=45    # 45 Seconds
      SLEEP_TIME=255 # 4 Minutes 15 Seconds

      send_heartbeat() {
          if [ -n "$HEARTBEAT_URL" ]; then
              echo "Sending heartbeat..."
              curl -fsS -m 5 --retry 3 "$HEARTBEAT_URL" > /dev/null 2>&1
          fi
      }

      echo "Initializing keep-vm-alive..."
      echo "Method: stress-ng (All Cores)"
      echo "Configuration: Cycle 5m | Load $CPU_LOAD% | Active ${RUN_TIME}s | Sleep ${SLEEP_TIME}s"

      while true; do
          # 1. Send Heartbeat (Every 5 mins)
          send_heartbeat

          # 2. Stress CPU (Active Phase)
          echo "Starting stress cycle..."
          stress-ng --cpu 0 --cpu-load $CPU_LOAD --timeout $RUN_TIME --metrics-brief

          # 3. Sleep (Idle Phase)
          echo "Cycle finished. Sleeping for ${SLEEP_TIME}s..."
          sleep $SLEEP_TIME
      done

- name: Create keep-vm-alive systemd service
  ansible.builtin.copy:
    owner: root
    group: root
    mode: "0644"
    dest: /etc/systemd/system/keep-vm-alive.service
    content: |
      [Unit]
      Description=Oracle Cloud Reclamation Prevention (stress-ng)
      After=network.target

      [Service]
      ExecStart=/usr/local/bin/keep-vm-alive
      Type=simple
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable keep-vm-alive service
  ansible.builtin.service:
    service: keep-vm-alive
    state: started
    enabled: true
