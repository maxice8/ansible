{
    {% if caddy_crowdsec_api_key != "" -%}
    crowdsec {
        api_key {{ caddy_crowdsec_api_key }}
    }
    order crowdsec first
    {% endif -%}
    servers {
        metrics
    }
    # Global options block
    log {
        output file /var/log/caddy/caddy_main.log {
            roll_size 100MiB
            roll_keep 5
            roll_keep_for 100d
        }
        format json
        level INFO
    }
}

:2019 {
    metrics
}

{% if 'forgejo' in configured_services -%}
git.{{ domain_name }} {
    reverse_proxy localhost:{{ forgejo_port }}
    {% if caddy_crowdsec_api_key != "" -%}
    route {
        crowdsec
    }
    {% endif -%}
    log {
        output file /var/log/caddy/git.{{ domain_name }}.log {
            roll_size 100MiB
            roll_keep 5
            roll_keep_for 100d
        }
        format json
        level INFO
    }
}
{% endif -%}
{% if 'whoami' in configured_services -%}
whoami.{{ domain_name }} {
    reverse_proxy localhost:{{ whoami_port }}
    {% if caddy_crowdsec_api_key != "" -%}
    route {
        crowdsec
    }
    {% endif -%}
    log {
        output file /var/log/caddy/whoami.{{ domain_name }}.log {
            roll_size 100MiB
            roll_keep 5
            roll_keep_for 100d
        }
        format json
        level INFO
    }
}
{% endif -%}
{% if 'ghost' in configured_services -%}
{{ ghost_domain_name }} {
    reverse_proxy localhost:{{ ghost_port }}
    {% if caddy_crowdsec_api_key != "" -%}
    route {
        crowdsec
    }
    {% endif -%}
    log {
        output file /var/log/caddy/{{ ghost_domain_name }}.log {
            roll_size 100MiB
            roll_keep 5
            roll_keep_for 100d
        }
        format json
        level INFO
    }

	# Optional: Enable gzip compression
	encode gzip
}
{% endif -%}
{% if 'uptime_kuma' in configured_services -%}
uptime.{{ domain_name }} {
    # Public Access Control
    @status_page {
        path /
        path /status*
        path /assets*
        path /api/status-page*
        path /icon.svg
        path /favicon.ico
    }

    # Proxy allowed traffic
    handle @status_page {
        reverse_proxy localhost:{{ uptime_kuma_port }}
    }

    # Block everything else with a 403 Forbidden
    handle {
        respond "Forbidden" 403
    }

    {% if caddy_crowdsec_api_key != "" -%}
    route {
        crowdsec
    }
    {% endif -%}

    log {
        output file /var/log/caddy/uptime.{{ domain_name }}.log {
            roll_size 100MiB
            roll_keep 5
            roll_keep_for 100d
        }
        format json
        level INFO
    }
}
{% endif -%}